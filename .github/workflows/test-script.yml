name: Test Host Init Script

on:
  # push:
  #   branches: ["main", "master"]
  # pull_request:
  #   branches: ["main", "master"]
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  test-on-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (拉取代码)
        uses: actions/checkout@v4

      - name: Grant Execute Permission (赋予执行权限)
        run: chmod +x host-init.sh

      - name: Run Script in Silent Mode (非交互式运行)
        # 必须使用 sudo，因为脚本需要 root 权限
        # 通过设置环境变量来跳过所有 read -p 交互
        run: |
          sudo -E ./host-init.sh
        env:
          # --- 配置参数区 ---
          CFG_HOSTNAME: "test-runner"
          CFG_SSH_PORT: "2222" # 测试改端口
          CFG_INSTALL_ZSH: "true"
          CFG_ZSH_DEFAULT: "false" # CI环境不要改默认shell，可能会断
          CFG_INSTALL_FAIL2BAN: "true"
          CFG_INSTALL_DOCKER: "true"
          CFG_SWAP_SIZE: "0" # CI环境通常无法挂载Swap，建议设为0
          CFG_SSH_PUBKEY: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC..." # 随便填个假的公钥测试写入
          CFG_GIT_NAME: "CI Bot"
          CFG_GIT_EMAIL: "ci@example.com"
          # 脚本会自动检测网络，无需手动指定 Docker 源

      - name: Verify Installation (验证结果)
        # 脚本跑完后，检查关键软件是否真的装上了
        run: |
          echo "Testing Zsh..."
          zsh --version

          echo "Testing Neovim..."
          /opt/nvim-linux-x86_64/bin/nvim --version

          echo "Testing Docker..."
          docker --version

          echo "Testing SSH Config..."
          # 检查端口是否被改为 2222
          grep "Port 2222" /etc/ssh/sshd_config

          echo "Testing Fail2Ban..."
          # 检查服务状态 (CI容器里可能无法完美启动，但可以检查文件)
          test -f /etc/fail2ban/jail.d/sshd.local
